<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>API test page</title>
</head>
<body>
    <script>
        async function initIframeAPI({src, name}) {
            const iframe = document.createElement("iframe");
            iframe.setAttribute("sandbox", "allow-scripts");
            iframe.setAttribute("style", "display: none;");
            iframe.setAttribute("src", src);

            document.body.append(iframe);
            await new Promise(resolve => {
                iframe.addEventListener("load", resolve);
            });

            let i = 0; const seed = Math.random();
            return function(inputData) {
                const id = `${name}:${seed}:${i++}`;
                iframe.contentWindow.postMessage({inputData, id}, "*");
                return new Promise(resolve => {
                    window.addEventListener("message", event => {
                        const {data, from, messageId} = event.data;
                        if (name === from && id === messageId) {
                            resolve(data);
                        }
                    }); // todo remove listener
                });
            }
        }

        !async function main() {
            const matchGfyId = await initIframeAPI({
                src: "https://alttiri.github.io/gfycat-id-camel-caser/iframe-api.html",
                name: "gfy-id-camel-caser"
            });
            globalThis.matchGfyId = matchGfyId; // for testing in the console

            // The example
            /** @type {MatchResult} */
            const result = await matchGfyId("redbluecat");
            console.log("matchGfyId:", result);
        }();
    </script>
</body>
</html>
